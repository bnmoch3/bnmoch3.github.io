<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://bnm3k.github.io//favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bnm3k.github.io//favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://bnm3k.github.io//favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://bnm3k.github.io//android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://bnm3k.github.io//apple-touch-icon.png><meta name=description content><title>Arrays, Constraints & Immutable Functions | bnm 3000
</title><link rel=canonical href=https://bnm3k.github.io/blog/pg-arrays-constraints-immutable-functions/><meta property="og:url" content="https://bnm3k.github.io/blog/pg-arrays-constraints-immutable-functions/"><meta property="og:site_name" content="bnm 3000"><meta property="og:title" content="Arrays, Constraints & Immutable Functions"><meta property="og:description" content="Tightening what kinds of values array columns can hold using constraints and immutable functions"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2024-12-28T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-28T00:00:00+00:00"><meta property="article:tag" content="PostgreSQL"><meta property="article:tag" content="SQL"><link rel=stylesheet href=/assets/combined.min.186794b3399a702d3092949042cdc215dea303c17e71e7c0254768448de11db8.css media=all></head><body class=light><div class=content><header><div class=header><div class=flex><p class=small><a href=/>/home</a></p><p class=small><a href=/posts>/posts</a></p><p class=small><a href=/notes>/notes</a></p><p class=small><a href=/tags>/tags</a></p></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a>
<span class=breadcrumbs-separator>> </span><a href=/notes/>Notes</a>
<span class=breadcrumbs-separator>> </span><a class=breadcrumbs-current href=/blog/pg-arrays-constraints-immutable-functions/>Arrays, Constraints & Immutable Functions</a></div><div><div class=single-intro-container><h1 class=single-title>Arrays, Constraints & Immutable Functions</h1><p class=single-readtime><time datetime=2024-12-28T00:00:00+00:00>December 28, 2024</time>
&nbsp; · &nbsp;
2 min read</p></div><div class=single-tags><span><a href=https://bnm3k.github.io/tags/postgresql/>#PostgreSQL</a>
</span><span><a href=https://bnm3k.github.io/tags/sql/>#SQL</a></span></div><div class=single-content><p>TIL you can use immutable functions in Postgres check constraints. I learnt this
from Sehrope Sarkuni&rsquo;s PGConfig NYC 2021 talk:
&ldquo;<a href="https://www.youtube.com/watch?v=lkWiyEe2RUQ">Advanced Postgres Schema Design&mldr;</a>&rdquo;.</p><p>From the Postgres docs, immutable functions:</p><blockquote><p>cannot modify the database and always returns the same result when given the
same argument values; that is, it does not do database lookups or otherwise
use information not directly present in its argument list</p></blockquote><p>When coupled with check constraints on arrays, they let us &rsquo;tighten&rsquo; the kind of
values an array column can take in.</p><p>Let&rsquo;s use an example; suppose we&rsquo;ve got a table where we&rsquo;re storing room IDs and
the days of the week those rooms are available (Monday is 1, Sunday is 7):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=font-weight:700>create</span> <span style=font-weight:700>table</span> room(
</span></span><span style=display:flex><span>    id int <span style=font-weight:700>primary</span> <span style=font-weight:700>key</span>,
</span></span><span style=display:flex><span>    available int[] <span style=font-weight:700>not</span> <span style=font-weight:700>null</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>The first constraint we&rsquo;ll add is that values in the array have to be within 1
and 7:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=font-weight:700>create</span> <span style=font-weight:700>function</span> array_contains_valid_iso_days(int[]) <span style=font-weight:700>returns</span> bool
</span></span><span style=display:flex><span><span style=font-weight:700>language</span> <span style=font-weight:700>sql</span> <span style=font-weight:700>immutable</span> <span style=font-weight:700>as</span>
</span></span><span style=display:flex><span><span>$$</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>select</span> <span style=font-weight:700>not</span> <span style=font-weight:700>exists</span> (<span style=font-weight:700>select</span> 1 <span style=font-weight:700>from</span> <span style=font-weight:700>unnest</span>(<span>$</span>1) x <span style=font-weight:700>where</span> x &lt; 1 <span style=font-weight:700>or</span> x &gt; 7);
</span></span><span style=display:flex><span><span>$$</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>alter</span> <span style=font-weight:700>table</span> room <span style=font-weight:700>add</span> <span style=font-weight:700>constraint</span> room_ck_valid_iso_days
</span></span><span style=display:flex><span>  <span style=font-weight:700>check</span>(array_contains_valid_iso_days(available) <span style=font-weight:700>is</span> <span style=font-weight:700>true</span>);
</span></span></code></pre></div><p>The following insertion will fail, since 8,9 and 10 don&rsquo;t represent a valid day
of the week:</p><pre tabindex=0><code>&gt; insert into room(id,available) values (1,&#39;{8,9,10}&#39;);

ERROR:  23514: new row for relation &#34;room&#34; violates check constraint &#34;room_ck_valid_iso_days&#34;
DETAIL:  Failing row contains (1, {8,9,10}).
SCHEMA NAME:  public
TABLE NAME:  room
CONSTRAINT NAME:  room_ck_valid_iso_days
LOCATION:  ExecConstraints, execMain.c:2039
</code></pre><p>This insertion will work though:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=font-weight:700>insert</span> <span style=font-weight:700>into</span> room(id,available) <span style=font-weight:700>values</span> (1,<span style=font-style:italic>&#39;{{1,2},{3,4}}&#39;</span>);
</span></span></code></pre></div><p>So the next constraint has to be on dimensions, entries must have only 1
dimension. After deleting the previous row (with multi-dimensional days), let&rsquo;s
add the following constraint:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=font-weight:700>alter</span> <span style=font-weight:700>table</span> room <span style=font-weight:700>add</span> <span style=font-weight:700>constraint</span> room_ck_array_dim_1
</span></span><span style=display:flex><span>  <span style=font-weight:700>check</span>(array_ndims(available)=1);
</span></span></code></pre></div><p>Arrays allow for duplicate values. In our case though, it does not make sense
for a day to be repeated more than once:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=font-weight:700>insert</span> <span style=font-weight:700>into</span> room(id,available) <span style=font-weight:700>values</span> (2,<span style=font-style:italic>&#39;{1,2,2,2,4}&#39;</span>);
</span></span></code></pre></div><p>Let&rsquo;s add a constraint that ensures all values of the array are unique (there
are no duplicate days of the week):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=font-weight:700>create</span> <span style=font-weight:700>function</span> array_has_no_duplicates(int[]) <span style=font-weight:700>returns</span> bool
</span></span><span style=display:flex><span><span style=font-weight:700>language</span> <span style=font-weight:700>sql</span> <span style=font-weight:700>immutable</span> <span style=font-weight:700>as</span>
</span></span><span style=display:flex><span><span>$$</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>select</span> <span style=font-weight:700>count</span>(*) = <span style=font-weight:700>count</span>(<span style=font-weight:700>distinct</span> e) <span style=font-weight:700>from</span> <span style=font-weight:700>unnest</span>(<span>$</span>1) <span style=font-weight:700>as</span> e;
</span></span><span style=display:flex><span><span>$$</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>alter</span> <span style=font-weight:700>table</span> room <span style=font-weight:700>add</span> <span style=font-weight:700>constraint</span> room_ck_no_duplicates
</span></span><span style=display:flex><span>    <span style=font-weight:700>check</span>(array_has_no_duplicates(available) <span style=font-weight:700>is</span> <span style=font-weight:700>true</span>);
</span></span></code></pre></div><p>Finally, though not necessary, we can add a constraint to ensure the values are
sorted (I got this directly from Sarkuni&rsquo;s slides):</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=font-weight:700>create</span> <span style=font-weight:700>or</span> <span style=font-weight:700>replace</span> <span style=font-weight:700>function</span> array_sort(int[]) <span style=font-weight:700>returns</span> int[]
</span></span><span style=display:flex><span><span style=font-weight:700>language</span> <span style=font-weight:700>sql</span> <span style=font-weight:700>immutable</span> <span style=font-weight:700>as</span>
</span></span><span style=display:flex><span><span>$$</span>
</span></span><span style=display:flex><span>    <span style=font-weight:700>select</span> array_agg(e <span style=font-weight:700>order</span> <span style=font-weight:700>by</span> e) <span style=font-weight:700>from</span> <span style=font-weight:700>unnest</span>(<span>$</span>1) <span style=font-weight:700>as</span> e
</span></span><span style=display:flex><span><span>$$</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>alter</span> <span style=font-weight:700>table</span> room <span style=font-weight:700>add</span> <span style=font-weight:700>constraint</span> room_ck_is_sorted
</span></span><span style=display:flex><span>    <span style=font-weight:700>check</span>(array_sort(available) = available);
</span></span></code></pre></div></div><div class=single-pagination><hr><div class=flex><div class=single-pagination-next><div class=single-pagination-container-next><div class=single-pagination-text>←</div><div class=single-pagination-text><a href=/blog/postgres-iceberg-sync-duckdb/>PostgreSQL to Iceberg Snapshot Sync (Using DuckDB)</a></div></div></div><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text><a href=/blog/pg-kill-connection/>Killing a PostgreSQL Connection</a></div><div class=single-pagination-text>→</div></div></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>&mldr;</p></footer></body><script>function isAuto(){return document.body.classList.contains("auto")}function setTheme(){if(!isAuto())return;document.body.classList.remove("auto");let e="light";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark"),document.body.classList.add(e)}function invertBody(){document.body.classList.toggle("dark"),document.body.classList.toggle("light")}isAuto()&&window.matchMedia("(prefers-color-scheme: dark)").addListener(invertBody),setTheme()</script></html>