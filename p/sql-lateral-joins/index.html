<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://bnmoch3.org/favicon.ico?><link rel=icon type=image/png sizes=16x16 href=https://bnmoch3.org/favicon-16x16.png?><link rel=icon type=image/png sizes=32x32 href=https://bnmoch3.org/favicon-32x32.png?><link rel=icon type=image/png sizes=192x192 href=https://bnmoch3.org/android-chrome-192x192.png?><link rel=apple-touch-icon sizes=180x180 href=https://bnmoch3.org/apple-touch-icon.png?><meta name=description content><title>Lateral Joins & Iterators in SQL | bnmoch3
</title><link rel=canonical href=https://bnmoch3.org/p/sql-lateral-joins/><meta property="og:url" content="https://bnmoch3.org/p/sql-lateral-joins/"><meta property="og:site_name" content="bnmoch3"><meta property="og:title" content="Lateral Joins & Iterators in SQL"><meta property="og:description" content="Sneaking for-loops into SQL without anyone noticing"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-24T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-24T00:00:00+00:00"><meta property="article:tag" content="SQL"><meta property="article:tag" content="PostgreSQL"><link rel=stylesheet href=/assets/combined.min.01980ad4202828eb32272e7b1654f79f3c0022c15b1c932668dff73dffaf7e88.css media=all></head><body class=light><div class=content><header><div class=header><div class=flex><p class=small><a href=/>/home</a></p><p class=small><a href=/about>/about</a></p><p class=small><a href=/posts>/posts</a></p><p class=small><a href=/notes>/notes</a></p><p class=small><a href=/tags>/tags</a></p></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a>
<span class=breadcrumbs-separator>> </span><a href=/posts/>Posts</a>
<span class=breadcrumbs-separator>> </span><a class=breadcrumbs-current href=/p/sql-lateral-joins/>Lateral Joins & Iterators in SQL</a></div><div><div class=single-intro-container><h1 class=single-title>Lateral Joins & Iterators in SQL</h1><p class=single-readtime><time datetime=2023-06-24T00:00:00+00:00>June 24, 2023</time>
&nbsp; Â· &nbsp;
8 min read</p></div><div class=single-content><p>First thing&rsquo;s first, lateral joins are not quite a different type of joins -
it&rsquo;s a way for sneaking in for-loops into SQL. With that in mind, let&rsquo;s use a
rather contrived example to introduce lateral joins.</p><p>Suppose we&rsquo;re running a social music streaming app. Users can follow each other
plus, of course, stream songs. We want to add the following feature (let me
phrase it in Jira speak): &lsquo;as a user, I want to get the top 5 songs the people I
follow have been listening to in the past 1 week, that I haven&rsquo;t listened to
yet - so that I can, uhh, listen to them?&rsquo;</p><h2 class=heading id=data-definition>Data definition
<a href=#data-definition>#</a></h2><p>Let&rsquo;s first flesh out the tables, nothing too fancy:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>table</span><span style=color:#bbb> </span>users(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id<span style=color:#bbb> </span><span style=color:#007020>int</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>primary</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>key</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>name<span style=color:#bbb> </span><span style=color:#007020>varchar</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>null</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>joined_on<span style=color:#bbb> </span><span style=color:#007020>date</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>table</span><span style=color:#bbb> </span>follow_list(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id<span style=color:#bbb> </span><span style=color:#007020>int</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>references</span><span style=color:#bbb> </span>users(user_id)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>on</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>delete</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>cascade</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>followed_by<span style=color:#bbb> </span><span style=color:#007020>int</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>references</span><span style=color:#bbb> </span>users(user_id)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>on</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>delete</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>cascade</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>primary</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>key</span>(user_id,<span style=color:#bbb> </span>followed_by),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>check</span><span style=color:#bbb> </span>(user_id<span style=color:#bbb> </span><span style=color:#666>&lt;&gt;</span><span style=color:#bbb> </span>followed_by)<span style=color:#bbb> </span><span style=color:#60a0b0;font-style:italic>-- user can&#39;t follow themselves
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>table</span><span style=color:#bbb> </span>songs(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>song_id<span style=color:#bbb> </span><span style=color:#007020>int</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>primary</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>key</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>name<span style=color:#bbb> </span><span style=color:#007020>varchar</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>null</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>artist<span style=color:#bbb> </span><span style=color:#007020>varchar</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>null</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>table</span><span style=color:#bbb> </span>song_plays(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id<span style=color:#bbb> </span><span style=color:#007020>int</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>null</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>references</span><span style=color:#bbb> </span>users(user_id),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>song_id<span style=color:#bbb> </span><span style=color:#007020>int</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>null</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>references</span><span style=color:#bbb> </span>songs(song_id),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>ts<span style=color:#bbb> </span>timestamptz<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>null</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>default</span><span style=color:#bbb> </span>now()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>insert</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>into</span><span style=color:#bbb> </span>users<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>values</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#40a070>1</span>,<span style=color:#bbb> </span><span style=color:#4070a0>&#39;Alice&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#40a070>2</span>,<span style=color:#bbb> </span><span style=color:#4070a0>&#39;Bob&#39;</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(<span style=color:#40a070>3</span>,<span style=color:#bbb> </span><span style=color:#4070a0>&#39;Eve&#39;</span>);<span style=color:#bbb>
</span></span></span></code></pre></div><p>Every time a user plays a song, it&rsquo;s recorded in the <code>song_plays</code>, <code>ts</code> is the
time they played it.</p><h2 class=heading id=building-block-queries>Building block queries
<a href=#building-block-queries>#</a></h2><p>Let&rsquo;s start by getting everyone Alice follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id,<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>user_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>follow_list<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>join</span><span style=color:#bbb> </span>users<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>using</span>(user_id)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb> </span>followed_by<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>follows<span style=color:#bbb>
</span></span></span></code></pre></div><p>Bob is one of the users Alice follows. This is how we get his top 5 most played
songs in the past week:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>song_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>num_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>song_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>2</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>and</span><span style=color:#bbb> </span>ts<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>now()<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;1 week&#39;</span>::<span style=color:#007020>interval</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>group</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb>  </span>song_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb>  </span>num_plays<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>desc</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>limit</span><span style=color:#bbb> </span><span style=color:#40a070>5</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>We also have to keep track of the songs Alice has already played:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>distinct</span><span style=color:#bbb> </span>song_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>song_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb> </span>user_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>1</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><h2 class=heading id=client-side-querying-and-iteration>Client side querying and iteration
<a href=#client-side-querying-and-iteration>#</a></h2><p>Let&rsquo;s now bring in everything together for version 1 of the feature:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>alice_id <span style=color:#666>=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>alice_playlist <span style=color:#666>=</span> []
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>with</span> conn<span style=color:#666>.</span>cursor() <span style=color:#007020;font-weight:700>as</span> cur:
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic># get already played songs to filter out</span>
</span></span><span style=display:flex><span>    sql <span style=color:#666>=</span> <span style=color:#4070a0>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    select distinct song_id
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    from song_plays
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    where user_id = </span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>;
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    cur<span style=color:#666>.</span>execute(sql, (alice_id,))
</span></span><span style=display:flex><span>    res <span style=color:#666>=</span> cur<span style=color:#666>.</span>fetchall()
</span></span><span style=display:flex><span>    already_played <span style=color:#666>=</span> <span style=color:#007020>tuple</span>(song_id <span style=color:#007020;font-weight:700>for</span> row <span style=color:#007020;font-weight:700>in</span> res <span style=color:#007020;font-weight:700>for</span> song_id <span style=color:#007020;font-weight:700>in</span> row)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic># get followees</span>
</span></span><span style=display:flex><span>    sql <span style=color:#666>=</span> <span style=color:#4070a0>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    select
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        user_id,
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        name
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    from follow_list f
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    join users using(user_Id)
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    where followed_by = </span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>
</span></span></span><span style=display:flex><span><span style=color:#4070a0>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    cur<span style=color:#666>.</span>execute(sql, (alice_id,))
</span></span><span style=display:flex><span>    follows <span style=color:#666>=</span> cur<span style=color:#666>.</span>fetchall()
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(follows)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic># for each followee, get their top-5 most played songs in the past</span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic># week, filter out songs the user has already played</span>
</span></span><span style=display:flex><span>    sql <span style=color:#666>=</span> <span style=color:#4070a0>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    select
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        </span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        name,
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        artist,
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        num_plays
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    from songs
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    join (
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    select
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        song_id,
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        count(*) as num_plays
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    from song_plays
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    join songs using(song_id)
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    where
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        user_id = </span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        and ts &gt; now() - &#39;1 week&#39;::interval
</span></span></span><span style=display:flex><span><span style=color:#4070a0>        and song_id not in </span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    group by  song_id
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    order by  num_plays desc
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    limit 5
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    ) as top_songs using(song_id)
</span></span></span><span style=display:flex><span><span style=color:#4070a0>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span> (followee_id, followee_name) <span style=color:#007020;font-weight:700>in</span> follows:
</span></span><span style=display:flex><span>        cur<span style=color:#666>.</span>execute(sql, (followee_name, followee_id, already_played))
</span></span><span style=display:flex><span>        alice_playlist<span style=color:#666>.</span>extend(cur<span style=color:#666>.</span>fetchall())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># print Alice&#39;s generated playlist playlist</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> entry <span style=color:#007020;font-weight:700>in</span> alice_playlist:
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(entry)
</span></span></code></pre></div><p>The one thing that sticks out like a sore thumb is that there is a lot of back
and forth querying between the client and the database for stuff that could be
handled entirely within Postgres in one sweep. This increases the latency and
amount of unnecessary workload. Let&rsquo;s fix it.</p><h2 class=heading id=set-returning-functions>Set returning functions
<a href=#set-returning-functions>#</a></h2><p>As the first step towards keeping as much of the workload within Postgres, let&rsquo;s
create a function which given a user and someone they follow, returns the top 5
songs the followee listened to in the past week. It should also filter out songs
the user has already listened to. For this, we&rsquo;ll use set-returning functions.</p><p>Dimitri Fontaine, author of &lsquo;The Art of Postgres&rsquo;, defines a set returning
function as:</p><blockquote><p>a PostgreSQL Stored Procedure that can be used as a relation: from a single
call it returns an entire result set, much like a subquery or a table -
<a href=https://tapoueh.org/blog/2017/10/set-returning-functions-and-postgresql-10/>Set Returning Functions and PostgreSQL 10</a></p></blockquote><p><a href=https://www.postgresql.org/docs/15/xfunc-sql.html#XFUNC-SQL-TABLE-FUNCTIONS>This section</a>
of the Postgres documentation introduce set returning functions quite well.
Probably the most well-known set returning function is <code>generate_series</code>.</p><p>For our case, this will do:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>function</span><span style=color:#bbb> </span>top_songs(u_id<span style=color:#bbb> </span><span style=color:#007020>integer</span>,<span style=color:#bbb> </span>followee_id<span style=color:#bbb> </span><span style=color:#007020>integer</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>returns</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>table</span>(song_id<span style=color:#bbb> </span><span style=color:#007020>int</span>,<span style=color:#bbb> </span>num_plays<span style=color:#bbb> </span><span style=color:#007020>int</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span><span>$$</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>song_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>num_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>song_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>user_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>followee_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>and</span><span style=color:#bbb> </span>ts<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>now()<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;1 week&#39;</span>::<span style=color:#007020>interval</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>and</span><span style=color:#bbb> </span>song_id<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>in</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>distinct</span><span style=color:#bbb> </span>song_id<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>song_plays<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb> </span>user_id<span style=color:#666>=</span>u_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>group</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb>  </span>song_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb>  </span>num_plays<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>desc</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>limit</span><span style=color:#bbb> </span><span style=color:#40a070>5</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span>$$</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>language</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>sql</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Wiring it up to the overall query:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>followee_name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>s.name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>s.artist,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>t.num_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>user_id<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>followee_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>name<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>followee_name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>followed_by<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>user_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>follow_list<span style=color:#bbb> </span>f<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>join</span><span style=color:#bbb> </span>users<span style=color:#bbb>  </span><span style=color:#007020;font-weight:700>using</span>(user_id)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb> </span>followed_by<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>f,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>top_songs(user_id,<span style=color:#bbb> </span>followee_id)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>t<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>join</span><span style=color:#bbb> </span>songs<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>s<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>using</span>(song_id)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb> </span>f.followee_id<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>asc</span>,<span style=color:#bbb> </span>t.num_plays<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>desc</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Two rather implicit things to note in the above query:</p><ul><li>the comma in between the subquery <code>f</code> and <code>top_songs</code> results in a cross join:
this is a kind of join where each row in the left table is matched with all
rows in the right table - resulting in all possible combinations. I&rsquo;d say it&rsquo;s
the building block for all other kinds of joins but that&rsquo;s a post for another
day.</li><li>we&rsquo;ve just used a lateral join; it&rsquo;s time to formally introduce the
<code>lateral keyword</code></li></ul><h2 class=heading id=lateral-joins>Lateral Joins
<a href=#lateral-joins>#</a></h2><p>Once more, lateral joins aren&rsquo;t a kind of join (unlike inner joins, left joins
etc). Rather, <code>lateral</code> is a keyword that when appended before a subquery or
function in the <code>from</code> section, let&rsquo;s it &lsquo;access&rsquo; the columns from the prior
table expressions.</p><p>Let&rsquo;s wind back a bit and revisit the order of SQL queries: We start with <code>from</code>
then <code>joins</code> then the <code>where clause</code> and so on:</p><p><figure><div><img loading=lazy alt="SQL query order" src=https://jvns.ca/images/sql-queries.jpeg></div></figure></p><p>The image above is from Julia Evans&rsquo; blog post
<a href=https://jvns.ca/blog/2019/10/03/sql-queries-don-t-start-with-select/>SQL queries don&rsquo;t start with SELECT</a>,
all credits due.</p><p>Loosely speaking, before a subquery is joined with another table, it is
evaluated once fully into a single table.</p><p>However, in our case, we have to generate the top songs on the fly for everyone
a user follows. This necessitates some form of row-by-row iteration - hence the
need for the lateral keyword. With lateral, the subquery or function is
evaluated iteratively for every row in from the prior result set. The
subquery/function can also reference columns from the prior result set such as
in a <code>where</code> clause to filter out songs a user has already listened to. The rows
from the subquery/function are then &lsquo;combined&rsquo; back, since it&rsquo;s a <code>join</code> after
all.</p><p>We didn&rsquo;t use the lateral keyword for the <code>top_songs</code> function even though it
refers to the <code>user_id</code> and <code>followee_id</code> columns since Postgres makes it
optional.</p><p>However, for subqueries, we have to use <code>lateral</code>. Let&rsquo;s also make the cross
join explicit and track the songs already played using a
<a href=https://www.postgresql.org/docs/current/queries-with.html>Common Table Expression</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>with</span><span style=color:#bbb> </span>already_played<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>distinct</span><span style=color:#bbb> </span>song_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>song_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb> </span>user_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>followee_name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>songs.name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>songs.artist,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>top_songs.num_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>user_id<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>followee_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>name<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>followee_name<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>follow_list<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>join</span><span style=color:#bbb> </span>users<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>using</span>(user_id)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb> </span>followed_by<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>1</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>f<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>cross</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>join</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>lateral</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>song_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>num_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>song_plays<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>where</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>user_id<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>f.followee_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>and</span><span style=color:#bbb> </span>ts<span style=color:#bbb> </span><span style=color:#666>&gt;</span><span style=color:#bbb> </span>now()<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;1 week&#39;</span>::<span style=color:#007020>interval</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>and</span><span style=color:#bbb> </span>song_id<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>not</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>in</span><span style=color:#bbb> </span>(<span style=color:#007020;font-weight:700>select</span><span style=color:#bbb> </span>song_id<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>already_played)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>group</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb>  </span>song_id<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb>  </span>num_plays<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>desc</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>limit</span><span style=color:#bbb> </span><span style=color:#40a070>5</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>top_songs<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>join</span><span style=color:#bbb> </span>songs<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>using</span>(song_id)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb> </span>followee_id<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>asc</span>,<span style=color:#bbb> </span>num_plays<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>desc</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>With this query, we get the entire result within a single round-trip, no more
back and forth. And by using <code>lateral</code> with a subquery, we don&rsquo;t have to create
and maintain a function within Postgres, everything&rsquo;s right there within the
query. Note, when subqueries are used in the above manner, they are referred to
as <em>correlated subqueries</em>. From
<a href=https://en.wikipedia.org/wiki/Correlated_subquery>wikipedia</a>, a correlated
subquery is a &lsquo;subquery that uses values from the outer query&rsquo;</p><h2 class=heading id=simplifyingreusing-expressions>Simplifying/Reusing expressions
<a href=#simplifyingreusing-expressions>#</a></h2><p>Additionally, the lateral keyword can also use it to simplify queries as
highlighted in both
<a href=https://stackoverflow.com/a/65847555>Vlad Mihalcea&rsquo;s Stack Overflow answer</a>
and this
<a href=https://popsql.com/learn-sql/postgresql/how-to-use-lateral-joins-in-postgresql#data-set>PopSQL post</a>
that introduces Lateral Joins. I&rsquo;ll heavily borrow Mihalcea&rsquo;s example:</p><p>In our <code>users</code> table above, we were also keeping track of the day the users
created an account via the <code>joined_on</code> column. Suppose we want to send out some
offers to users based on:</p><ul><li>how many years they&rsquo;ve been members</li><li>the date of their next anniversary</li><li>the number of days remaining until their next anniversary</li></ul><p>This query does the trick:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>joined_on,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>extract</span><span style=color:#bbb> </span>(<span style=color:#007020;font-weight:700>year</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>age(now(),<span style=color:#bbb> </span>joined_on))<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>years_active,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(joined_on<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>(<span style=color:#007020;font-weight:700>extract</span>(<span style=color:#007020;font-weight:700>year</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>age(now(),<span style=color:#bbb> </span>joined_on))<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;1 year&#39;</span>::<span style=color:#007020>interval</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>)::<span style=color:#007020>date</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>next_anniversary,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(joined_on<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>(<span style=color:#007020;font-weight:700>extract</span>(<span style=color:#007020;font-weight:700>year</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>age(now(),<span style=color:#bbb> </span>joined_on))<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;1 year&#39;</span>::<span style=color:#007020>interval</span>)::<span style=color:#007020>date</span><span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>now()::<span style=color:#007020>date</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>days_remaining<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>users<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb> </span>days_remaining<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>asc</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Notice that some of the sub-expressions are repeated over and over again: we can
polish it up by using a lateral join to abstract out the <code>years_active</code>
expression:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>joined_on,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>years_active,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(joined_on<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>(years_active<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span>)<span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;1 year&#39;</span>::<span style=color:#007020>interval</span>)::<span style=color:#007020>date</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>next_anniversary,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>(joined_on<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>(years_active<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span>)<span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;1 year&#39;</span>::<span style=color:#007020>interval</span>)::<span style=color:#007020>date</span><span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>now()::<span style=color:#007020>date</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>days_remaining<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>users,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>lateral</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>extract</span><span style=color:#bbb> </span>(<span style=color:#007020;font-weight:700>year</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>age(now(),<span style=color:#bbb> </span>joined_on))<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>years_active<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>e1<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb> </span>days_remaining<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>asc</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>We can polish it up further by using yet another lateral join:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>name,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>joined_on,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>years_active,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>next_anniversary,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>next_anniversary<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>now()::<span style=color:#007020>date</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>days_remaining<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>users,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>lateral</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>extract</span><span style=color:#bbb> </span>(<span style=color:#007020;font-weight:700>year</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>from</span><span style=color:#bbb> </span>age(now(),<span style=color:#bbb> </span>joined_on))<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>years_active<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>e1,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>lateral</span><span style=color:#bbb> </span>(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb> </span>(joined_on<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>(years_active<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span>)<span style=color:#bbb> </span><span style=color:#666>*</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;1 year&#39;</span>::<span style=color:#007020>interval</span>)::<span style=color:#007020>date</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>next_anniversary<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span>e2<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>order</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>by</span><span style=color:#bbb> </span>days_remaining<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>asc</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Here are some links and posts for further reading:</p><h2 class=heading id=linksacknowledgment>Links/Acknowledgment
<a href=#linksacknowledgment>#</a></h2><ul><li><a href=https://www.postgresql.org/docs/15/sql-select.html>PostgreSQL Documentation - SQL Commands - SELECT,TABLE,WITH</a></li><li><a href=https://www.postgresql.org/docs/15/queries-table-expressions.html>PostgreSQL Documentation - Table Expressions</a></li><li><a href=https://www.postgresql.org/docs/15/xfunc-sql.html#XFUNC-SQL-FUNCTIONS-RETURNING-SET>PostgreSQL Documentation - Query Language (SQL) Functions</a></li><li><a href=https://www.heap.io/blog/postgresqls-powerful-new-join-type-lateral>Dan Robinson - Heap - PostgreSQL&rsquo;s Powerful New Join Type:
Lateral</a></li><li><a href=https://stackoverflow.com/questions/28550679/what-is-the-difference-between-a-lateral-join-and-a-subquery-in-postgresql>StackOverflow - What is the difference between a LATERAL JOIN and a subquery in PostgreSQL</a></li><li><a href=https://popsql.com/learn-sql/postgresql/how-to-use-lateral-joins-in-postgresql#data-set>PopSQL - How to Use Lateral Joins in PostgreSQL</a></li><li><a href=https://www.crunchydata.com/blog/iterators-in-postgresql-with-lateral-joins>Steve Pousty - CrunchyData - Iterators in PostgreSQL with Lateral Joins</a></li><li><a href=https://blog.jooq.org/add-lateral-joins-or-cross-apply-to-your-sql-tool-chain/>lukaseder - jooq - Add LATERAL Joins or CROSS APPLY to Your SQL Tool Chain</a></li></ul></div><div class=single-pagination><hr><div class=flex><div class=single-pagination-next><div class=single-pagination-container-next><div class=single-pagination-text>â</div><div class=single-pagination-text><a href=/p/parquet-zstd/>Parquet + Zstd: Smaller faster data formats</a></div></div></div><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text><a href=/p/sql-grouping-sets/>SQL Grouping sets, Rollups & Cube</a></div><div class=single-pagination-text>â</div></div></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>&mldr;</p></footer></body><script>function isAuto(){return document.body.classList.contains("auto")}function setTheme(){if(!isAuto())return;document.body.classList.remove("auto");let e="light";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark"),document.body.classList.add(e)}function invertBody(){document.body.classList.toggle("dark"),document.body.classList.toggle("light")}isAuto()&&window.matchMedia("(prefers-color-scheme: dark)").addListener(invertBody),setTheme()</script></html>