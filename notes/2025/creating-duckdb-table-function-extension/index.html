<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://bnmoch3.org/favicon.ico?><link rel=icon type=image/png sizes=16x16 href=https://bnmoch3.org/favicon-16x16.png?><link rel=icon type=image/png sizes=32x32 href=https://bnmoch3.org/favicon-32x32.png?><link rel=icon type=image/png sizes=192x192 href=https://bnmoch3.org/android-chrome-192x192.png?><link rel=apple-touch-icon sizes=180x180 href=https://bnmoch3.org/apple-touch-icon.png?><meta name=description content><title>Creating a DuckDB Table Function Extension | bnmoch3</title><link rel=canonical href=https://bnmoch3.org/notes/2025/creating-duckdb-table-function-extension/><meta property="og:url" content="https://bnmoch3.org/notes/2025/creating-duckdb-table-function-extension/"><meta property="og:site_name" content="bnmoch3"><meta property="og:title" content="Creating a DuckDB Table Function Extension"><meta property="og:description" content="Alternatively: A DuckDB Table Function Extension Starter Code"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2025-01-14T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-14T00:00:00+00:00"><meta property="article:tag" content="DuckDB"><link rel=stylesheet href=/assets/combined.min.bfb51fa3110844de3117ce8da7190d50165deb2fc526273808d6975119098310.css media=all></head><body class=light><div class=content><header><div class=header><div class=flex><p class=small><a href=/>/home</a></p><p class=small><a href=/about>/about</a></p><p class=small><a href=/posts>/posts</a></p><p class=small><a href=/notes>/notes</a></p><p class=small><a href=/tags>/tags</a></p></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a>
<span class=breadcrumbs-separator>> </span><a href=/notes/>Notes</a>
<span class=breadcrumbs-separator>> </span><a class=breadcrumbs-current href=/notes/2025/creating-duckdb-table-function-extension/>Creating a DuckDB Table Function Extension</a></div><div><div class=single-intro-container><h1 class=single-title>Creating a DuckDB Table Function Extension</h1><p class=single-readtime><time datetime=2025-01-14T00:00:00+00:00>January 14, 2025</time>
&nbsp; · &nbsp;
9 min read</p></div><div class=single-tags><span><a href=https://bnmoch3.org/tags/duckdb/>#DuckDB</a></span></div><aside class=toc><p><strong>Table of contents</strong></p><nav id=TableOfContents><ul><li><a href=#overview-of-creating-table-function-extensions>Overview of Creating Table Function Extensions</a></li><li><a href=#table-function-example-fibonacci-sequence>Table Function Example: Fibonacci Sequence</a><ul><li><a href=#bind>Bind</a></li><li><a href=#init-global>Init Global</a></li><li><a href=#init-local>Init Local</a></li><li><a href=#table-producing-function>Table Producing Function</a></li><li><a href=#setting-up-the-extension>Setting up the Extension</a></li></ul></li><li><a href=#exercises-left-to-the-reader>Exercises Left to the Reader</a></li><li><a href=#references>References</a></li></ul></nav></aside><div class=single-content><p>This quick guide is intended for developers familiar with DuckDB and basic C++
who are interested in creating their own table producing DuckDB extensions. At
the very least, you should be familiar with the
<a href=https://github.com/duckdb/extension-template>DuckDB Basic Extension Template</a>.</p><p>Table producing functions are functions that can be called in the <code>FROM</code> part of
a query to generate tuples usually by reading from an external source. Probably
the most commonly used table function in DuckDB is the
<a href=https://duckdb.org/docs/data/csv/overview.html><code>read_csv</code> table function</a> - if
you&rsquo;ve done CSV imports before then you&rsquo;ve already encountered table functions.</p><p>DuckDB does let us extend its base functionality by creating our own extensions.
The DuckDB team provides a
<a href=https://github.com/duckdb/extension-template>template</a> that authors can use as
a starting point. However, the template is for scalar functions. I couldn&rsquo;t find
a template for table functions on github that&rsquo;s why I wrote this post. Later on,
as I was searching online, I came across @grammaright&rsquo;s
<a href=https://blog.debug.sexy/duckdb/extension/dbms/2024/04/09/How-to-make-a-DuckDB-extension-for-a-table-function.html>How to Make a DuckDB Extension for a Table Function?</a>.
I&rsquo;d suggest you start off from @grammaright&rsquo;s post since I&rsquo;ll be referencing it
a couple of times, both implicitly (my bad) and explicitly.</p><p>Before proceeding, I&rsquo;d like to warn, I&rsquo;m not a professional/experienced C++
developer, the last time I wrote C++ was back in college - please feel free to
point out any errors I&rsquo;ve made in my writing or sample code so that this post
can be more useful. Also for future reference, the DuckDB version I&rsquo;m using is
<code>v1.1.3 19864453f7</code>.</p><h2 class=heading id=overview-of-creating-table-function-extensions>Overview of Creating Table Function Extensions
<a href=#overview-of-creating-table-function-extensions>#</a></h2><p>Using a table function extension involves 2 steps:</p><ol><li>Loading the extension</li><li>Calling the table function</li></ol><p>For step 1, to make an extension &rsquo;loadable&rsquo;, we have to provide its name and a
<code>load</code> method which will be invoked to register the extension.</p><p>For step 2, calling a table function involves the following steps:</p><ol><li><strong>Binding</strong>:<ul><li>On query processing, upon encountering the table function, DuckDB invokes
its associated bind function</li><li>The bind function processes the input arguments. For example, in the
<code>read_csv</code> function, the input argument is the CSV file path or set of CSV
files paths</li><li>The bind function also defines the schema for the table (names and data
types for the columns)</li><li>Finally, the bind function initializes the <code>FunctionData</code> object which
holds the bind data</li></ul></li><li><strong>Initializing Global State</strong>:<ul><li>DuckDB invokes the <code>init_global</code> before reading tuples from the table</li><li><code>init_global</code> creates a <code>GlobalTableFunctionData</code> object</li><li>This object will hold the <em>global</em> state that will be shared across worker
threads</li><li>It goes without saying, concurrent access to the global state should be
synchronized</li><li>The global state has a <code>MaxThreads</code> method which tells DuckDB the maximum
number of worker threads that will be allocated for processing the table
function</li></ul></li><li><strong>Initializing Local State</strong>:<ul><li>Within each worker thread, the <code>init_local</code> function is invoked</li><li><code>init_local</code> creates a <code>LocalTableFunctionState</code> object which holds the
local state</li></ul></li><li><strong>Invoking the Table Function</strong>:<ul><li>Within each worker thread, the table function is invoked one or more times</li><li>The table function has access to the bind data, local state and global
state</li><li>The local state is local to the worker thread, no need to synchronize
access to it</li><li>The table function produces tuples and informs DuckDB how many tuples it
has generated</li><li>Once done, the table function sets the cardinality of its output to zero to
indicate it is done producing tuples</li></ul></li></ol><p>When writing a table function extension, there are many ways to break up the
steps. Here&rsquo;s the order I used:</p><ol start=0><li>Think about what input arguments my table function will need and what will be
the schema of its output</li><li>Define the bind data structure and bind function.</li><li>Define the global state structure and <code>init_global</code></li><li>Define the local state structure and <code>init_local</code></li><li>Define the table function</li><li>Define the overall Extension, including how its load function and arguments
it will table</li></ol><h2 class=heading id=table-function-example-fibonacci-sequence>Table Function Example: Fibonacci Sequence
<a href=#table-function-example-fibonacci-sequence>#</a></h2><p>As an example, we&rsquo;ll create a function that generates the fibonacci sequence.
Here&rsquo;s how it looks like in action:</p><pre tabindex=0><code>D load fib;
D select *  from fibonacci(10);
┌────────┬────────┐
│   i    │   f    │
│ uint64 │ uint64 │
├────────┼────────┤
│      0 │      0 │
│      1 │      1 │
│      2 │      1 │
│      3 │      2 │
│      4 │      3 │
│      5 │      5 │
│      6 │      8 │
│      7 │     13 │
│      8 │     21 │
│      9 │     34 │
├────────┴────────┤
│     10 rows     │
└─────────────────┘
</code></pre><h3 class=heading id=bind>Bind
<a href=#bind>#</a></h3><p>Let&rsquo;s start with the bind data and bind function. For bind data, since the
function takes in the number of fibonacci values to produce, we&rsquo;ll hold it in
<code>max</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>FibBindData</span> <span style=color:#666>:</span> <span style=color:#007020;font-weight:700>public</span> TableFunctionData {
</span></span><span style=display:flex><span>    <span style=color:#902000>uint64_t</span> max;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Now for the bind function; it should be of type <code>table_function_bind_t</code> which
has the following definition
(<a href=https://github.com/duckdb/duckdb/blob/945a96cd3fffc49b1522342f710b9b133f77107b/src/include/duckdb/function/table_function.hpp#L249>src/include/duckdb/function/table_function.hpp</a>):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>typedef</span> unique_ptr<span style=color:#666>&lt;</span>FunctionData<span style=color:#666>&gt;</span> (<span style=color:#666>*</span>table_function_bind_t)(
</span></span><span style=display:flex><span>    ClientContext <span style=color:#666>&amp;</span>context,
</span></span><span style=display:flex><span>    TableFunctionBindInput <span style=color:#666>&amp;</span>input,
</span></span><span style=display:flex><span>    vector<span style=color:#666>&lt;</span>LogicalType<span style=color:#666>&gt;</span> <span style=color:#666>&amp;</span>return_types,
</span></span><span style=display:flex><span>    vector<span style=color:#666>&lt;</span>string<span style=color:#666>&gt;</span> <span style=color:#666>&amp;</span>names
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>A couple of notes:</p><ul><li><code>ClientContext</code> &ldquo;holds information relevant to the current client session
during execution&rdquo; (from the code&rsquo;s comments,
<a href=https://github.com/duckdb/duckdb/blob/945a96cd3fffc49b1522342f710b9b133f77107b/src/include/duckdb/main/client_context.hpp>src/include/duckdb/main/client_context.hpp</a>).
Client context includes stuff like transaction and table info and methods for
e.g. querying</li><li><code>TableFunctionBindInput</code> includes the arguments the user provided in their
query plus a bunch of other stuff
(<a href=https://github.com/duckdb/duckdb/blob/e0d79a7eb019477b12976b33352a2370d48d2cad/src/include/duckdb/function/table_function.hpp#L89>src/include/duckdb/function/table_function.hpp</a>)</li><li>We use <code>&amp;return_types</code> and <code>&amp;names</code> to define the output schema</li></ul><p>Here&rsquo;s the bind function for the fibonacci extension:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>unique_ptr<span style=color:#666>&lt;</span>FunctionData<span style=color:#666>&gt;</span> FibBind(
</span></span><span style=display:flex><span>    ClientContext <span style=color:#666>&amp;</span>context,
</span></span><span style=display:flex><span>    TableFunctionBindInput <span style=color:#666>&amp;</span>input,
</span></span><span style=display:flex><span>    vector<span style=color:#666>&lt;</span>LogicalType<span style=color:#666>&gt;</span> <span style=color:#666>&amp;</span>return_types,
</span></span><span style=display:flex><span>    vector<span style=color:#666>&lt;</span>string<span style=color:#666>&gt;</span> <span style=color:#666>&amp;</span>names)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// retrieve the argument provided by the user
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>auto</span> max <span style=color:#666>=</span> IntegerValue<span style=color:#666>::</span>Get(input.inputs[<span style=color:#40a070>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (max <span style=color:#666>&lt;</span> <span style=color:#40a070>0</span> <span style=color:#666>||</span> max <span style=color:#666>&gt;</span> <span style=color:#40a070>93</span>) { <span style=color:#60a0b0;font-style:italic>// max &gt;= 0 &amp;&amp; max &lt;= 93, at 94 and above overflows
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#007020;font-weight:700>throw</span> <span style=color:#06287e>BinderException</span>(<span style=color:#4070a0>&#34;Invalid input: n must be between 0 and 93 (inclusive)</span>. <span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>                             <span style=color:#4070a0>&#34;Values less than 0 are not allowed, and values greater than 93 exceed the maximum limit for 64-bit unsigned integers.&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>auto</span> bind_data <span style=color:#666>=</span> make_uniq<span style=color:#666>&lt;</span>FibBindData<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>    bind_data<span style=color:#666>-&gt;</span>max <span style=color:#666>=</span> max;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// schema
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    return_types.push_back(LogicalType<span style=color:#666>::</span>UBIGINT);
</span></span><span style=display:flex><span>    names.emplace_back(<span style=color:#4070a0>&#34;i&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return_types.push_back(LogicalType<span style=color:#666>::</span>UBIGINT);
</span></span><span style=display:flex><span>    names.emplace_back(<span style=color:#4070a0>&#34;f&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> std<span style=color:#666>::</span>move(bind_data);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 class=heading id=init-global>Init Global
<a href=#init-global>#</a></h3><p>Our fibonacci table function will be single threaded so there really isn&rsquo;t much
to do here since we won&rsquo;t be using global state to coordinate across concurrent
worker threads. In fact, we don&rsquo;t even need to define a global state struct and
an init global function - the defaults work fine if we set init global to null
when initializing the extension.</p><p>However, for the sake of completion, I&rsquo;ve included it here:</p><p>The struct that will hold global state is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>FibGlobalState</span> <span style=color:#666>:</span> <span style=color:#007020;font-weight:700>public</span> GlobalTableFunctionState {
</span></span><span style=display:flex><span>    FibGlobalState() {};
</span></span><span style=display:flex><span>    <span style=color:#666>~</span>FibGlobalState() <span style=color:#007020;font-weight:700>override</span> {}
</span></span><span style=display:flex><span>    idx_t <span style=color:#06287e>MaxThreads</span>() <span style=color:#007020;font-weight:700>const</span> <span style=color:#007020;font-weight:700>override</span> { <span style=color:#007020;font-weight:700>return</span> <span style=color:#40a070>1</span>; <span style=color:#60a0b0;font-style:italic>/* single threaded */</span> };
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>private</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>mutable</span> mutex main_mutex;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>The init global function has to be of type <code>table_function_init_global_t</code> which
has the following definition
(<a href=https://github.com/duckdb/duckdb/blob/e0d79a7eb019477b12976b33352a2370d48d2cad/src/include/duckdb/function/table_function.hpp#L108>src/include/duckdb/function/table_function.hpp</a>):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>typedef</span> unique_ptr<span style=color:#666>&lt;</span>GlobalTableFunctionState<span style=color:#666>&gt;</span> (<span style=color:#666>*</span>table_function_init_global_t)(
</span></span><span style=display:flex><span>    ClientContext <span style=color:#666>&amp;</span>context,
</span></span><span style=display:flex><span>    TableFunctionInitInput <span style=color:#666>&amp;</span>input
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>We&rsquo;ve already encountered <code>ClientContext</code>.</p><p>As for <code>TableFunctionInitInput</code>
(<a href=https://github.com/duckdb/duckdb/blob/e0d79a7eb019477b12976b33352a2370d48d2cad/src/include/duckdb/function/table_function.hpp#L108>src/include/duckdb/function/table_function.hpp</a>),
it&rsquo;s used for:</p><ul><li>passing the <code>bind_data</code> from the binding phase</li><li>providing information about columns (<code>column_ids</code> and <code>projection_ids</code>) and
filters for projection and filter pushdowns</li></ul><p>Our init global function is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>unique_ptr<span style=color:#666>&lt;</span>GlobalTableFunctionState<span style=color:#666>&gt;</span> FibInitGlobal(
</span></span><span style=display:flex><span>    ClientContext <span style=color:#666>&amp;</span>context,
</span></span><span style=display:flex><span>    TableFunctionInitInput <span style=color:#666>&amp;</span>input)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>auto</span> <span style=color:#666>&amp;</span>bind_data <span style=color:#666>=</span> input.bind_data<span style=color:#666>-&gt;</span>Cast<span style=color:#666>&lt;</span>FibBindData<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> make_uniq<span style=color:#666>&lt;</span>FibGlobalState<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 class=heading id=init-local>Init Local
<a href=#init-local>#</a></h3><p>The struct that will hold local state is as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>FibLocalState</span> <span style=color:#666>:</span> <span style=color:#007020;font-weight:700>public</span> LocalTableFunctionState {
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>public</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#902000>uint64_t</span> a; <span style=color:#60a0b0;font-style:italic>// prev fibonacci number
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#902000>uint64_t</span> b; <span style=color:#60a0b0;font-style:italic>// curr fibonacci number
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#902000>uint64_t</span> curr_index; <span style=color:#60a0b0;font-style:italic>// index
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>    FibLocalState() <span style=color:#666>:</span> a(<span style=color:#40a070>0</span>), b(<span style=color:#40a070>1</span>), curr_index(<span style=color:#40a070>0</span>) {}
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>The init local function has to be of type <code>table_function_init_local_t</code> which
has the following definition
(<a href=https://github.com/duckdb/duckdb/blob/e0d79a7eb019477b12976b33352a2370d48d2cad/src/include/duckdb/function/table_function.hpp#L254>src/include/duckdb/function/table_function.hpp</a>):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>typedef</span> unique_ptr<span style=color:#666>&lt;</span>LocalTableFunctionState<span style=color:#666>&gt;</span> (<span style=color:#666>*</span>table_function_init_local_t)(
</span></span><span style=display:flex><span>    ExecutionContext <span style=color:#666>&amp;</span>context,
</span></span><span style=display:flex><span>    TableFunctionInitInput <span style=color:#666>&amp;</span>input,
</span></span><span style=display:flex><span>    GlobalTableFunctionState <span style=color:#666>*</span>global_state
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>A couple of notes:</p><ul><li><code>ExecutionContext</code>
(<a href=https://github.com/duckdb/duckdb/blob/e0d79a7eb019477b12976b33352a2370d48d2cad/src/include/duckdb/execution/execution_context.hpp#L19>src/include/duckdb/execution/execution_context.hpp</a>)
can be used to access the <code>ClientContext</code> and thread-local context</li><li><code>TableFunctionInitInput</code>: we&rsquo;ve already encountered this - it&rsquo;s one of the
parameters for init global</li><li><code>GlobalTableFunctionState</code>: this is the global state that&rsquo;s initialized in
init global</li></ul><p>For our init local function, we&rsquo;ve got:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>unique_ptr<span style=color:#666>&lt;</span>LocalTableFunctionState<span style=color:#666>&gt;</span> FibInitLocal(
</span></span><span style=display:flex><span>    ExecutionContext <span style=color:#666>&amp;</span>context,
</span></span><span style=display:flex><span>    TableFunctionInitInput <span style=color:#666>&amp;</span>input,
</span></span><span style=display:flex><span>    GlobalTableFunctionState <span style=color:#666>*</span>global_state_p)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> make_uniq<span style=color:#666>&lt;</span>FibLocalState<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 class=heading id=table-producing-function>Table Producing Function
<a href=#table-producing-function>#</a></h3><p>Now for the core of the extension - the table function. This should be of type
<code>table_function_t</code> which has the following definition
(<a href=https://github.com/duckdb/duckdb/blob/e0d79a7eb019477b12976b33352a2370d48d2cad/src/include/duckdb/function/table_function.hpp#L259>src/include/duckdb/function/table_function.hpp</a>):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>typedef</span> <span style=color:#06287e>void</span> (<span style=color:#666>*</span>table_function_t)(
</span></span><span style=display:flex><span>    ClientContext <span style=color:#666>&amp;</span>context,
</span></span><span style=display:flex><span>    TableFunctionInput <span style=color:#666>&amp;</span>data,
</span></span><span style=display:flex><span>    DataChunk <span style=color:#666>&amp;</span>output
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>A couple of notes:</p><ul><li><p><code>ClientContext</code>: we&rsquo;ve already encountered this in the bind function (as a
parameter), init global (as a parameter) and init local (as part of
<code>ExecutionContext</code>)</p></li><li><p><code>TableFunctionInput</code>
(<a href=https://github.com/duckdb/duckdb/blob/e0d79a7eb019477b12976b33352a2370d48d2cad/src/include/duckdb/function/table_function.hpp#L150>src/include/duckdb/function/table_function.hpp</a>):
we use this to access the bind data, global state and local state. As
mentioned earlier, bind data should be treated as read only.</p></li><li><p><code>DataChunk</code>
(<a href=https://github.com/duckdb/duckdb/blob/b76b8f7b2b1fa7c2169fabecb31fecc3d8d381cd/src/include/duckdb/common/types/data_chunk.hpp>src/include/duckdb/common/types/data_chunk.hpp</a>):
this is the chunk in memory where we&rsquo;ll write the tuples we&rsquo;re producing (e.g.
from parsing from a csv or parquet file) and also set the cardinality of our
output</p><p>Our fibonacci table function is as follows:</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>void</span> <span style=color:#06287e>FibFunction</span>(
</span></span><span style=display:flex><span>    ClientContext <span style=color:#666>&amp;</span>context,
</span></span><span style=display:flex><span>    TableFunctionInput <span style=color:#666>&amp;</span>data_p,
</span></span><span style=display:flex><span>    DataChunk <span style=color:#666>&amp;</span>output)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// get bind data, global state and local state
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>auto</span> <span style=color:#666>&amp;</span>bind_data <span style=color:#666>=</span> data_p.bind_data<span style=color:#666>-&gt;</span>Cast<span style=color:#666>&lt;</span>FibBindData<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>auto</span> <span style=color:#666>&amp;</span>global_state <span style=color:#666>=</span> data_p.global_state<span style=color:#666>-&gt;</span>Cast<span style=color:#666>&lt;</span>FibGlobalState<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>auto</span> <span style=color:#666>&amp;</span>local_state <span style=color:#666>=</span> data_p.local_state<span style=color:#666>-&gt;</span>Cast<span style=color:#666>&lt;</span>FibLocalState<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// determine how many rows to insert
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>if</span> (local_state.curr_index <span style=color:#666>==</span> bind_data.max){
</span></span><span style=display:flex><span>         output.SetCardinality(<span style=color:#40a070>0</span>);
</span></span><span style=display:flex><span>         <span style=color:#007020;font-weight:700>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>auto</span> remaining <span style=color:#666>=</span> bind_data.max <span style=color:#666>-</span> local_state.curr_index;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>auto</span> size <span style=color:#666>=</span> MinValue<span style=color:#666>&lt;</span>idx_t<span style=color:#666>&gt;</span>(remaining, STANDARD_VECTOR_SIZE);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// set cardinality of output
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    output.SetCardinality(size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// get columns
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>auto</span> ith_vals <span style=color:#666>=</span> FlatVector<span style=color:#666>::</span>GetData<span style=color:#666>&lt;</span><span style=color:#902000>uint64_t</span><span style=color:#666>&gt;</span>(output.data[<span style=color:#40a070>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>auto</span> fib_vals <span style=color:#666>=</span> FlatVector<span style=color:#666>::</span>GetData<span style=color:#666>&lt;</span><span style=color:#902000>uint64_t</span><span style=color:#666>&gt;</span>(output.data[<span style=color:#40a070>1</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    idx_t i <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// first fibonacci value
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>if</span> (local_state.curr_index <span style=color:#666>==</span> <span style=color:#40a070>0</span>) {
</span></span><span style=display:flex><span>        ith_vals[<span style=color:#40a070>0</span>] <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>        fib_vals[<span style=color:#40a070>0</span>] <span style=color:#666>=</span> local_state.a;
</span></span><span style=display:flex><span>        local_state.curr_index<span style=color:#666>++</span>;
</span></span><span style=display:flex><span>        i<span style=color:#666>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// second fibonacci value
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>if</span> (local_state.curr_index <span style=color:#666>==</span> <span style=color:#40a070>1</span> <span style=color:#666>&amp;&amp;</span> i <span style=color:#666>&lt;</span> size){
</span></span><span style=display:flex><span>        ith_vals[<span style=color:#40a070>1</span>] <span style=color:#666>=</span> <span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>        fib_vals[<span style=color:#40a070>1</span>] <span style=color:#666>=</span> local_state.b;
</span></span><span style=display:flex><span>        local_state.curr_index<span style=color:#666>++</span>;
</span></span><span style=display:flex><span>        i<span style=color:#666>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// fill columns
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>for</span> (; i <span style=color:#666>&lt;</span> size; i<span style=color:#666>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#902000>uint64_t</span> next <span style=color:#666>=</span> local_state.a <span style=color:#666>+</span> local_state.b;
</span></span><span style=display:flex><span>        local_state.a <span style=color:#666>=</span> local_state.b;
</span></span><span style=display:flex><span>        local_state.b <span style=color:#666>=</span> next;
</span></span><span style=display:flex><span>        fib_vals[i] <span style=color:#666>=</span> next;
</span></span><span style=display:flex><span>        ith_vals[i] <span style=color:#666>=</span> local_state.curr_index;
</span></span><span style=display:flex><span>        local_state.curr_index<span style=color:#666>++</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 class=heading id=setting-up-the-extension>Setting up the Extension
<a href=#setting-up-the-extension>#</a></h3><p>Everything above is brought together within the following class:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>FibExtension</span> <span style=color:#666>:</span> <span style=color:#007020;font-weight:700>public</span> Extension {
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>public</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>    <span style=color:#902000>void</span> Load(DuckDB <span style=color:#666>&amp;</span>db) <span style=color:#007020;font-weight:700>override</span>;
</span></span><span style=display:flex><span>    std<span style=color:#666>::</span>string Name() <span style=color:#007020;font-weight:700>override</span>;
</span></span><span style=display:flex><span>    std<span style=color:#666>::</span>string Version() <span style=color:#007020;font-weight:700>const</span> <span style=color:#007020;font-weight:700>override</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>The method implementations are as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>void</span> FibExtension<span style=color:#666>::</span>Load(DuckDB <span style=color:#666>&amp;</span>db) {
</span></span><span style=display:flex><span>    TableFunction <span style=color:#06287e>table_function</span>(
</span></span><span style=display:flex><span>        <span style=color:#4070a0>&#34;fibonacci&#34;</span>, <span style=color:#60a0b0;font-style:italic>// function name
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        {LogicalType<span style=color:#666>::</span>INTEGER}, <span style=color:#60a0b0;font-style:italic>// function arguments
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        FibFunction, <span style=color:#60a0b0;font-style:italic>// table function
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        FibBind, <span style=color:#60a0b0;font-style:italic>// bind function
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        FibInitGlobal, <span style=color:#60a0b0;font-style:italic>// init global function
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        FibInitLocal <span style=color:#60a0b0;font-style:italic>// init local function
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    );
</span></span><span style=display:flex><span>    ExtensionUtil<span style=color:#666>::</span>RegisterFunction(<span style=color:#666>*</span>db.instance, table_function); <span style=color:#60a0b0;font-style:italic>// register
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std<span style=color:#666>::</span>string FibExtension<span style=color:#666>::</span>Name() { <span style=color:#007020;font-weight:700>return</span> <span style=color:#4070a0>&#34;fib&#34;</span>; } <span style=color:#60a0b0;font-style:italic>// extension name
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>std<span style=color:#666>::</span>string FibExtension<span style=color:#666>::</span>Version() <span style=color:#007020;font-weight:700>const</span> { <span style=color:#007020;font-weight:700>return</span> <span style=color:#4070a0>&#34;&#34;</span>; }
</span></span></code></pre></div><h2 class=heading id=exercises-left-to-the-reader>Exercises Left to the Reader
<a href=#exercises-left-to-the-reader>#</a></h2><p>There&rsquo;s a lot more to table functions, we&rsquo;ve just scratched the surface. If
you&rsquo;re interested, here&rsquo;s more stuff you can explore:</p><ul><li>Add named parameters to the function. E.g. for fibonacci, the starting numbers
can be set via named parameters (0 and 1, 1 and 1, 1 and 2)</li><li>Handle filter pushdown</li><li>Handle projection pushdown</li><li>Provide DuckDB with overall cardinality of the table the function will produce</li><li>Provide DuckDB with scan progress (updates on how much the function has
produced thus far)</li><li>Add a statistics function?</li><li>Pick an example that can be multi-threaded e.g. a FizzBuzz table function</li></ul><h2 class=heading id=references>References
<a href=#references>#</a></h2><ol><li>DuckDB source code: <a href=https://github.com/duckdb/duckdb>repo</a></li><li>DuckDB Extension Template:
<a href=https://github.com/duckdb/extension-template>repo</a></li><li><a href=https://blog.debug.sexy/duckdb/extension/dbms/2024/04/09/How-to-make-a-DuckDB-extension-for-a-table-function.html>How to Make a DuckDB Extension for a Table Function? - @grammaright</a></li></ol><script src=https://giscus.app/client.js data-repo=bnmoch3/blog data-repo-id=R_kgDOIU86DQ data-category data-category-id=DIC_kwDOIU86Dc4Clvgl data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=gruvbox_light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div><div class=single-pagination><hr><div class=flex><div class=single-pagination-next><div class=single-pagination-container-next><div class=single-pagination-text>←</div><div class=single-pagination-text><a href=/notes/2025/cors-overview/>CORS</a></div></div></div><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text><a href=/notes/2025/postgres-iceberg-sync-duckdb/>PostgreSQL to Iceberg Snapshot Sync (Using DuckDB)</a></div><div class=single-pagination-text>→</div></div></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>&mldr;</p></footer><script async src=https://scripts.simpleanalyticscdn.com/latest.js></script></body><script>function isAuto(){return document.body.classList.contains("auto")}function setTheme(){if(!isAuto())return;document.body.classList.remove("auto");let e="light";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark"),document.body.classList.add(e)}function invertBody(){document.body.classList.toggle("dark"),document.body.classList.toggle("light")}isAuto()&&window.matchMedia("(prefers-color-scheme: dark)").addListener(invertBody),setTheme()</script></html>