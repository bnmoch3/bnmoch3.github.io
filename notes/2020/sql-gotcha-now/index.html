<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://bnmoch3.org/favicon.ico?><link rel=icon type=image/png sizes=16x16 href=https://bnmoch3.org/favicon-16x16.png?><link rel=icon type=image/png sizes=32x32 href=https://bnmoch3.org/favicon-32x32.png?><link rel=icon type=image/png sizes=192x192 href=https://bnmoch3.org/android-chrome-192x192.png?><link rel=apple-touch-icon sizes=180x180 href=https://bnmoch3.org/apple-touch-icon.png?><meta name=description content><title>SQL gotcha: now() vs 'now' | bnmoch3</title><link rel=canonical href=https://bnmoch3.org/notes/2020/sql-gotcha-now/><meta property="og:url" content="https://bnmoch3.org/notes/2020/sql-gotcha-now/"><meta property="og:site_name" content="bnmoch3"><meta property="og:title" content="SQL gotcha: now() vs 'now'"><meta property="og:description" content="Make sure you’re using the correct defaults when defining columns"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="notes"><meta property="article:published_time" content="2020-05-27T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-27T00:00:00+00:00"><meta property="article:tag" content="SQL"><meta property="article:tag" content="PostgreSQL"><link rel=stylesheet href=/assets/combined.min.bfb51fa3110844de3117ce8da7190d50165deb2fc526273808d6975119098310.css media=all></head><body class=light><div class=content><header><div class=header><div class=flex><p class=small><a href=/>/home</a></p><p class=small><a href=/about>/about</a></p><p class=small><a href=/posts>/posts</a></p><p class=small><a href=/notes>/notes</a></p><p class=small><a href=/tags>/tags</a></p></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a>
<span class=breadcrumbs-separator>> </span><a href=/notes/>Notes</a>
<span class=breadcrumbs-separator>> </span><a class=breadcrumbs-current href=/notes/2020/sql-gotcha-now/>SQL gotcha: now() vs 'now'</a></div><div><div class=single-intro-container><h1 class=single-title>SQL gotcha: now() vs 'now'</h1><p class=single-readtime><time datetime=2020-05-27T00:00:00+00:00>May 27, 2020</time>
&nbsp; · &nbsp;
1 min read</p></div><div class=single-content><p>Here&rsquo;s something new I learnt from <a href=https://korban.net/postgres/book/>Korban&rsquo;s</a>
Postgres course on handling time and temporal values.</p><p>When adding a default value for a timestamp column, there&rsquo;s a huge difference
between <code>now()</code> and <code>'now'</code> or even <code>'now()'</code>. The first one should be familiar,
if a timestamp value is not provided, the transaction timestamp (ie the time at
the start of the transaction) is inserted instead. However, the last two are the
same, and in most cases, probably not the intended default value: they return
the timestamp value at the time the table was created.</p><p>Consider the following table, keeping in mind the default values for both
<code>created_at</code> and <code>updated_at</code></p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>begin</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>select</span><span style=color:#bbb> </span>now();<span style=color:#bbb> 
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:41:34.208137
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>create</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>table</span><span style=color:#bbb> </span>users(<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>user_id<span style=color:#bbb> </span><span style=color:#007020>serial</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>primary</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>key</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>username<span style=color:#bbb> </span><span style=color:#007020>varchar</span>(<span style=color:#40a070>15</span>),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>created_at<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>default</span><span style=color:#bbb> </span>now(),<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>updated_at<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>timestamp</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>default</span><span style=color:#bbb> </span><span style=color:#4070a0>&#39;now()&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>commit</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><p>Now, on inserting a couple of items, we see how the <code>updated_at</code> column ends up
defaulting to the wrong value, unless, of course, it&rsquo;s what was really intended:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#007020;font-weight:700>insert</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>into</span><span style=color:#bbb> </span>users(username)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>values</span>(<span style=color:#4070a0>&#39;Alice&#39;</span>)<span style=color:#bbb> </span>returning<span style=color:#bbb> </span>now();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:41:53.857192 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:41:53.857192 (created_at) ✔️
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:41:34.208137 (updated_at) ❌ 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:41:34.208137 (table creation timestamp)
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#007020;font-weight:700>insert</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>into</span><span style=color:#bbb> </span>users(username)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>values</span>(<span style=color:#4070a0>&#39;Bob&#39;</span>)<span style=color:#bbb> </span>returning<span style=color:#bbb> </span>now();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:42:09.170153 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:42:09.170153 (created_at) ✔️
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:41:34.208137 (updated_at) ❌
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>--  2020-05-27 16:41:34.208137 (table creation timestamp)
</span></span></span></code></pre></div><script src=https://giscus.app/client.js data-repo=bnmoch3/blog data-repo-id=R_kgDOIU86DQ data-category data-category-id=DIC_kwDOIU86Dc4Clvgl data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=gruvbox_light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div><div class=single-pagination><hr><div class=flex><div class=single-pagination-next><div class=single-pagination-container-next><div class=single-pagination-text>←</div><div class=single-pagination-text><a href=/notes/2020/pg-unique-constraints/>Speeding up unique constraint checks in PostgreSQL... or not</a></div></div></div><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text><a href=/notes/2020/bugs-c-operator-associativity/>Bugs From ignoring C Operator Associativity</a></div><div class=single-pagination-text>→</div></div></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>&mldr;</p></footer><script async src=https://scripts.simpleanalyticscdn.com/latest.js></script></body><script>function isAuto(){return document.body.classList.contains("auto")}function setTheme(){if(!isAuto())return;document.body.classList.remove("auto");let e="light";window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e="dark"),document.body.classList.add(e)}function invertBody(){document.body.classList.toggle("dark"),document.body.classList.toggle("light")}isAuto()&&window.matchMedia("(prefers-color-scheme: dark)").addListener(invertBody),setTheme()</script></html>